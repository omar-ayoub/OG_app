name: Deploy to VPS

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint
        run: npm run lint

  deploy:
    name: Deploy to VPS
    needs: lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: replace

      - name: Adding Known Hosts
        run: ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_PATH: /home/omar/organizer_app
        run: |
          echo "üöÄ Starting deployment to VPS..."
          
          # Create directory if it doesn't exist
          ssh $VPS_USER@$VPS_HOST "mkdir -p $VPS_PATH"
          
          echo "üì¶ Copying files to VPS..."
          # Copy docker-compose file
          scp organizer-docker-compose.yml $VPS_USER@$VPS_HOST:$VPS_PATH/docker-compose.yml
          
          # Copy backend
          scp -r backend $VPS_USER@$VPS_HOST:$VPS_PATH/
          
          # Copy frontend source files
          scp -r src $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp -r public $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp package*.json $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp index.html $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp vite.config.ts $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp tsconfig*.json $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp tailwind.config.js $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp postcss.config.js $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp Dockerfile $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp nginx.conf $VPS_USER@$VPS_HOST:$VPS_PATH/
          scp .dockerignore $VPS_USER@$VPS_HOST:$VPS_PATH/ || true
          
          echo "üê≥ Deploying with Docker Compose..."
          # Deploy on VPS
          ssh $VPS_USER@$VPS_HOST << 'ENDSSH'
            cd /home/omar/organizer_app
            echo "  ‚Üí Stopping existing containers..."
            docker-compose down || true
            echo "  ‚Üí Building and starting services..."
            docker-compose up -d --build
            echo "  ‚Üí Waiting for services to start..."
            sleep 10
            echo "  ‚Üí Checking service status..."
            docker-compose ps
            echo "  ‚Üí Initializing database..."
            docker exec organizer_backend node scripts/init-database.js || echo "Database already initialized"
          ENDSSH
          
          echo "‚úÖ Deployment complete!"
          echo "üåê Your app is live at: http://46.202.189.243:8080"
